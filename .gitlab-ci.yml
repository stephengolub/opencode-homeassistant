# OpenCode Plugin - GitLab CI Pipeline
# TypeScript plugin for Home Assistant integration via MQTT

stages:
  - validate
  - test
  - build
  - docs
  - release

variables:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

default:
  image: node:${NODE_VERSION}-alpine
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull-push

# Install dependencies - shared setup
.npm-install:
  before_script:
    - npm ci

# Validate stage
lint:
  stage: validate
  extends: .npm-install
  script:
    - npm run build -- --noEmit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

typecheck:
  stage: validate
  extends: .npm-install
  script:
    - npx tsc --noEmit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Test stage
test:
  stage: test
  extends: .npm-install
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:coverage:
  stage: test
  extends: .npm-install
  script:
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build stage
build:
  stage: build
  extends: .npm-install
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Documentation stage
.docs-base:
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install mkdocs-material mike
  cache:
    key: docs-pip
    paths:
      - .cache/pip

# Build docs for MR preview
docs:build:
  extends: .docs-base
  stage: docs
  script:
    - mkdocs build --strict
  artifacts:
    paths:
      - site/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Deploy "latest" docs on merge to main
pages:
  extends: .docs-base
  stage: docs
  script:
    # Configure git for mike
    - apt-get update && apt-get install -y git
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    
    # Fetch existing gh-pages branch if it exists
    - git fetch origin gl-pages:gl-pages || true
    
    # Deploy as "latest" version with mike
    - mike deploy --push --update-aliases latest
    - mike set-default latest
    
    # Copy to public for GitLab Pages
    - mike deploy latest --branch gl-pages
    - git checkout gl-pages
    - mkdir -p public
    - cp -r * public/ || true
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deploy versioned docs on release tags
pages:release:
  extends: .docs-base
  stage: docs
  script:
    # Configure git for mike
    - apt-get update && apt-get install -y git
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    
    # Extract version from tag (v1.2.3 -> 1.2.3)
    - VERSION=${CI_COMMIT_TAG#v}
    - MAJOR_MINOR=$(echo $VERSION | cut -d. -f1,2)
    
    # Fetch existing gl-pages branch
    - git fetch origin gl-pages:gl-pages || true
    
    # Deploy this version and update latest alias
    - mike deploy --push --update-aliases $MAJOR_MINOR latest
    - mike set-default latest
    
    # Copy to public for GitLab Pages
    - git checkout gl-pages
    - mkdir -p public
    - cp -r * public/ || true
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# Release stage - publish to npm on tags
publish:
  stage: release
  extends: .npm-install
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - npm run build
    - npm publish --access public
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  environment:
    name: npm
    url: https://www.npmjs.com/package/ha-opencode

# Create GitLab release on tags
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## OpenCode Plugin ${CI_COMMIT_TAG}
      
      Install via npm:
      ```bash
      npm install ha-opencode@${CI_COMMIT_TAG#v}
      ```
      
      Documentation: https://opencode-home-assistant.gitlab.io/opencode-plugin/${CI_COMMIT_TAG#v}/
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
