# OpenCode Plugin - GitLab CI Pipeline
# TypeScript plugin for Home Assistant integration via MQTT

stages:
  - validate
  - test
  - build
  - docs
  - release

variables:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"

default:
  image: node:${NODE_VERSION}-alpine
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull-push

# Install dependencies - shared setup
.npm-install:
  before_script:
    - npm ci

# Validate stage
lint:
  stage: validate
  extends: .npm-install
  script:
    - npm run build -- --noEmit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

typecheck:
  stage: validate
  extends: .npm-install
  script:
    - npx tsc --noEmit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Test stage
test:
  stage: test
  extends: .npm-install
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:coverage:
  stage: test
  extends: .npm-install
  script:
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build stage
build:
  stage: build
  extends: .npm-install
  script:
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Documentation stage
.docs-base:
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install mkdocs-material
  cache:
    key: docs-pip
    paths:
      - .cache/pip

# Build docs for MR preview
docs:build:
  extends: .docs-base
  stage: docs
  script:
    - mkdocs build --strict
  artifacts:
    paths:
      - site/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Deploy docs on merge to main (as "latest")
pages:
  extends: .docs-base
  stage: docs
  script:
    - apt-get update && apt-get install -y curl jq
    
    # Build current docs
    - mkdocs build --strict
    
    # Create public directory structure with versioning
    - mkdir -p public/latest
    - cp -r site/* public/latest/
    
    # Try to fetch existing versions from Pages (if they exist)
    # This preserves previously deployed versions
    - |
      if curl -sf "https://opencode-home-assistant.gitlab.io/opencode-plugin/versions.json" -o existing_versions.json 2>/dev/null; then
        echo "Found existing versions.json"
        # Download each existing version
        for version in $(jq -r '.[] | select(.version != "latest") | .version' existing_versions.json); do
          echo "Fetching existing version: $version"
          mkdir -p "public/$version"
          curl -sf "https://opencode-home-assistant.gitlab.io/opencode-plugin/$version/index.html" -o "public/$version/index.html" 2>/dev/null || true
          # We can't easily fetch all files, so versioned docs will need to be rebuilt on release
        done
      fi
    
    # Create versions.json for version selector
    - |
      cat > public/versions.json << 'EOF'
      [
        {"version": "latest", "title": "latest", "aliases": ["latest"]}
      ]
      EOF
    
    # Create redirect from root to latest
    - |
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Redirecting...</title>
        <meta http-equiv="refresh" content="0; url=./latest/">
        <link rel="canonical" href="./latest/">
      </head>
      <body>
        <p>Redirecting to <a href="./latest/">latest documentation</a>...</p>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deploy versioned docs on release tags
pages:release:
  extends: .docs-base
  stage: docs
  script:
    - apt-get update && apt-get install -y curl jq
    
    # Extract version from tag (v1.2.3 -> 1.2)
    - VERSION=${CI_COMMIT_TAG#v}
    - MAJOR_MINOR=$(echo $VERSION | cut -d. -f1,2)
    - echo "Deploying docs for version $MAJOR_MINOR"
    
    # Build docs for this version
    - mkdocs build --strict
    
    # Create public directory
    - mkdir -p public/latest
    - mkdir -p "public/$MAJOR_MINOR"
    
    # Copy to both version and latest
    - cp -r site/* "public/$MAJOR_MINOR/"
    - cp -r site/* public/latest/
    
    # Try to fetch and merge with existing versions.json
    - |
      if curl -sf "https://opencode-home-assistant.gitlab.io/opencode-plugin/versions.json" -o existing_versions.json 2>/dev/null; then
        echo "Found existing versions.json"
        # Add new version if not already present
        if ! jq -e ".[] | select(.version == \"$MAJOR_MINOR\")" existing_versions.json > /dev/null 2>&1; then
          jq ". + [{\"version\": \"$MAJOR_MINOR\", \"title\": \"$MAJOR_MINOR\", \"aliases\": []}]" existing_versions.json > public/versions.json
        else
          cp existing_versions.json public/versions.json
        fi
        # Ensure latest is always first and points to this version
        jq "map(if .version == \"latest\" then .aliases = [\"$MAJOR_MINOR\"] else . end) | sort_by(.version) | reverse" public/versions.json > tmp.json && mv tmp.json public/versions.json
      else
        # Create new versions.json
        cat > public/versions.json << EOF
      [
        {"version": "latest", "title": "latest", "aliases": ["$MAJOR_MINOR"]},
        {"version": "$MAJOR_MINOR", "title": "$MAJOR_MINOR", "aliases": []}
      ]
      EOF
      fi
    
    # Create redirect from root to latest
    - |
      cat > public/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Redirecting...</title>
        <meta http-equiv="refresh" content="0; url=./latest/">
        <link rel="canonical" href="./latest/">
      </head>
      <body>
        <p>Redirecting to <a href="./latest/">latest documentation</a>...</p>
      </body>
      </html>
      EOF
    
    # Try to preserve other existing versions by downloading them
    - |
      for version in $(jq -r '.[] | select(.version != "latest" and .version != "'"$MAJOR_MINOR"'") | .version' public/versions.json 2>/dev/null); do
        echo "Attempting to preserve version: $version"
        mkdir -p "public/$version"
        # Download the version's index to check if it exists
        if curl -sf "https://opencode-home-assistant.gitlab.io/opencode-plugin/$version/index.html" -o "public/$version/index.html" 2>/dev/null; then
          echo "Version $version exists, but full preservation requires manual rebuild"
        fi
      done
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# Release stage - publish to npm on tags
publish:
  stage: release
  extends: .npm-install
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
    - npm run build
    - npm publish --access public
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  environment:
    name: npm
    url: https://www.npmjs.com/package/ha-opencode

# Create GitLab release on tags
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## OpenCode Plugin ${CI_COMMIT_TAG}
      
      Install via npm:
      ```bash
      npm install ha-opencode@${CI_COMMIT_TAG#v}
      ```
      
      Documentation: https://opencode-home-assistant.gitlab.io/opencode-plugin/
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
