# ha-opencode

OpenCode plugin for Home Assistant integration via MQTT Discovery.

Exposes OpenCode session state as Home Assistant entities and allows bidirectional control (responding to permission requests, sending prompts, viewing history).

## Features

- **Session-Based Identity**: Each OpenCode session gets its own HA device and entities
- **Real-time State Tracking**: Session state, model, current tool, tokens, and cost
- **Permission Handling**: Approve/reject permission requests from HA or mobile notifications
- **Send Prompts**: Send prompts to OpenCode sessions via MQTT
- **Session History**: Retrieve conversation history on demand
- **Agent Tracking**: Track primary agent and sub-agents being used
- **Hostname Display**: Identify which machine the session is running on
- **Automatic Cleanup**: Stale sessions (7+ days inactive) are automatically removed

## Installation

### 1. Install the plugin

```bash
npm install --prefix ~/.config/opencode /path/to/ha-opencode
```

### 2. Add to OpenCode config

Add `"ha-opencode"` to the `plugins` array in `~/.config/opencode/opencode.json`:

```json
{
  "plugins": ["ha-opencode"]
}
```

### 3. Configure MQTT connection

Via environment variables:

```bash
export MQTT_HOST=your-mqtt-broker.local
export MQTT_PORT=1883
export MQTT_USERNAME=optional-username
export MQTT_PASSWORD=optional-password
export HA_DISCOVERY_PREFIX=homeassistant  # default
```

Or via `opencode.json`:

```json
{
  "plugins": ["ha-opencode"],
  "ha-opencode": {
    "mqtt": {
      "host": "your-mqtt-broker.local",
      "port": 1883,
      "username": "optional-username",
      "password": "optional-password"
    },
    "ha": {
      "discoveryPrefix": "homeassistant"
    }
  }
}
```

Environment variables take precedence over JSON config.

## Session-Based Identity

Each OpenCode session creates a unique Home Assistant device:

- **Session ID**: `ses_46b09b89bffevq6HeMNIkuvk4B` (generated by OpenCode)
- **Device ID**: `opencode_46b09b89bffevq6HeMNIkuvk4B` (strips `ses_` prefix)
- **Initial Name**: `OpenCode - {projectName} - Untitled`
- **After Title**: `OpenCode - {projectName} - {sessionTitle}`

This allows running multiple concurrent OpenCode sessions in the same directory, each with their own entities.

## Entities Created

Per OpenCode session (device), the following entities are created:

| Entity | Type | Description |
|--------|------|-------------|
| `sensor.opencode_*_state` | Sensor | Session state (idle, working, waiting_permission, error) |
| `sensor.opencode_*_session_title` | Sensor | Current session/conversation title |
| `sensor.opencode_*_model` | Sensor | AI model being used (provider/model) |
| `sensor.opencode_*_current_tool` | Sensor | Currently executing tool |
| `sensor.opencode_*_tokens_input` | Sensor | Input token count |
| `sensor.opencode_*_tokens_output` | Sensor | Output token count |
| `sensor.opencode_*_cost` | Sensor | Session cost in USD |
| `sensor.opencode_*_last_activity` | Sensor | Timestamp of last activity |
| `sensor.opencode_*_permission` | Sensor | Permission request status |
| `sensor.opencode_*_device_id` | Sensor | Device identifier with command/response topics |

**Note**: The `*` in entity IDs represents the session ID (e.g., `sensor.opencode_46b09b89bffevq6HeMNIkuvk4B_state`).

### State Entity Attributes

The `state` entity includes these attributes:

- `previous_state`: The state before the current one (for automation conditions)
- `agent`: Primary agent selected by the user
- `current_agent`: Sub-agent currently being used (if any)
- `hostname`: Machine hostname where OpenCode is running
- `error_message`: Error details when in error state

### Device ID Entity Attributes

The `device_id` entity includes:

- `command_topic`: MQTT topic for sending commands
- `response_topic`: MQTT topic for receiving responses
- `state_topic_base`: Base topic for all state updates
- `device_name`: Friendly device name
- `session_id`: Full session ID (e.g., `ses_46b09b89bffevq6HeMNIkuvk4B`)
- `project_name`: Project directory name

## MQTT Topics

For a session with ID `ses_46b09b89bffevq6HeMNIkuvk4B`:

```
# State topics
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/state
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/state/attributes
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/session_title
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/model
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/availability

# Commands & responses
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/command
opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/response

# HA Discovery
homeassistant/sensor/opencode_46b09b89bffevq6HeMNIkuvk4B/state/config

# Global cleanup response
opencode/cleanup/response
```

## MQTT Commands

Send commands to the `command_topic` (e.g., `opencode/opencode_46b09b89bffevq6HeMNIkuvk4B/command`):

### Permission Response

```json
{
  "command": "permission_response",
  "permission_id": "perm-123",
  "response": "once"
}
```

Response options: `"once"`, `"always"`, or `"reject"`

### Send Prompt

```json
{
  "command": "prompt",
  "text": "Your prompt text here",
  "session_id": "optional-session-id"
}
```

### Get History

```json
{
  "command": "get_history",
  "session_id": "optional-session-id",
  "request_id": "optional-correlation-id"
}
```

### Get History Since

```json
{
  "command": "get_history_since",
  "since": "2024-01-01T00:00:00Z",
  "session_id": "optional-session-id",
  "request_id": "optional-correlation-id"
}
```

### Cleanup Stale Sessions

```json
{
  "command": "cleanup_stale_sessions",
  "max_age_days": 7
}
```

Response published to `opencode/cleanup/response`:

```json
{
  "type": "cleanup_result",
  "sessions_removed": 3,
  "session_ids": ["opencode_abc123...", "opencode_def456..."],
  "max_age_days": 7,
  "timestamp": "2025-01-07T12:00:00Z"
}
```

## Stale Session Cleanup

Sessions that haven't been active for 7 days are automatically cleaned up:

- **Automatic**: Runs on every plugin startup (async, non-blocking)
- **Manual**: Send `cleanup_stale_sessions` command via MQTT

Cleanup removes all HA entities for stale sessions by publishing empty configs to the discovery topics.

## Home Assistant Blueprints

Pre-built automation blueprints are available in the `blueprints/` directory:

| Blueprint | Description |
|-----------|-------------|
| `opencode_state_notifications.yaml` | Mobile notifications for task complete, permission required, and errors |
| `opencode_permission_response.yaml` | Handle approve/reject button taps from notifications |

### Installing Blueprints

1. Copy blueprints to your HA config:
   ```bash
   mkdir -p /path/to/ha/config/blueprints/automation/opencode
   cp blueprints/*.yaml /path/to/ha/config/blueprints/automation/opencode/
   ```

2. Reload automations in HA (Developer Tools > YAML > Reload Automations)

3. Create automations from blueprints:
   - Settings > Automations > Create Automation > Use Blueprint
   - Select the OpenCode blueprint
   - Configure your mobile device and preferences

See [ha-card/README.md](ha-card/README.md) for detailed blueprint configuration and automation examples.

## Home Assistant Card

A custom Lovelace card is included for displaying OpenCode sessions in Home Assistant.

See [ha-card/README.md](ha-card/README.md) for installation and usage instructions.

## Development

```bash
# Install dependencies
npm install

# Build TypeScript
npm run build

# Watch mode
npm run dev

# Run tests
npm test

# Run tests with coverage
npm run test:coverage
```

### Project Structure

```
src/
  index.ts      Plugin entry point, defers setup until first session event
  config.ts     Configuration loading (env vars + JSON)
  mqtt.ts       MQTT client wrapper with wildcard support
  discovery.ts  Session-based HA MQTT Discovery
  state.ts      State tracking and publishing
  commands.ts   MQTT command handler
  cleanup.ts    Stale session cleanup
  notify.ts     Terminal notification utilities (Kitty OSC 99)

blueprints/
  opencode_state_notifications.yaml    Mobile notification blueprint
  opencode_permission_response.yaml    Permission action handler

ha-card/
  src/          Custom Lovelace card source
  dist/         Built card JS
```

## Troubleshooting

### Too many entities in HA

Each session creates a new set of entities. Use the cleanup command or rely on automatic cleanup to remove old sessions. Sessions inactive for 7+ days are automatically removed on plugin startup.

### Entity naming shows "Untitled"

This is the initial name before session title is available. Once the session gets a proper title, the device name updates automatically.

### Automation not triggering

Check that `previous_state` attribute is available when state changes. Attributes are published BEFORE the state value to ensure they're available when automations trigger.

### Kitty notifications not working

Ensure your terminal supports OSC 99 (Kitty, iTerm2) and that stdout is a TTY.

## License

MIT
